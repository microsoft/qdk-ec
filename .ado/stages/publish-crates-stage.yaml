parameters:
- name: publishBinar
  type: boolean
- name: publishPaulimer
  type: boolean
- name: publishPauliverse
  type: boolean

stages:
- stage: publish_crates
  displayName: Publish Rust Crates
  dependsOn: approval
  condition: and(succeeded(), eq(variables['Build.Reason'], 'Manual'), or(eq(${{ parameters.publishBinar }}, true), eq(${{ parameters.publishPaulimer }}, true), eq(${{ parameters.publishPauliverse }}, true)))
  jobs:
  - job: "Publish_Crates"
    pool:
      name: "Azure-Pipelines-DevTools-EO"
      image: "ubuntu-latest"
      os: linux
    templateContext:
      type: releaseJob
      isProduction: true
    steps:
    - task: RustInstaller@1
      inputs:
        rustVersion: ms-prod-$(RUST_TOOLCHAIN_VERSION)
      displayName: Install Rust toolchain

    - script: |
        mkdir -p $(System.DefaultWorkingDirectory)/target/crates
      displayName: Create crates directory

    - script: |
        cd binar
        cargo package
        cp target/package/binar-*.crate $(System.DefaultWorkingDirectory)/target/crates/
        cd ..
      displayName: Package binar
      condition: eq(${{ parameters.publishBinar }}, true)
    
    - script: |
        cd paulimer
        cargo package
        cp target/package/paulimer-*.crate $(System.DefaultWorkingDirectory)/target/crates/
        cd ..
      displayName: Package paulimer
      condition: eq(${{ parameters.publishPaulimer }}, true)
    
    - script: |
        cd pauliverse
        cargo package
        cp target/package/pauliverse-*.crate $(System.DefaultWorkingDirectory)/target/crates/
        cd ..
      displayName: Package pauliverse
      condition: eq(${{ parameters.publishPauliverse }}, true)

    - script: |
        ls -la $(System.DefaultWorkingDirectory)/target/crates/
      displayName: List packaged crates

    - task: EsrpRelease@9
      condition: succeeded()
      displayName: Publish Rust crates to crates.io
      inputs:
        connectedservicename: "PME ESRP Azure Connection"
        usemanagedidentity: true
        keyvaultname: "quantum-esrp-kv"
        signcertname: ESRPCert
        clientid: "832c049d-cd07-4c1c-bfa5-c07250d190cb"
        contenttype: CratesIO
        domaintenantid: "975f013f-7f24-47e8-a7d3-abc4752bf346"
        folderlocation: "$(System.DefaultWorkingDirectory)/target/crates"
        waitforreleasecompletion: true
        owners: "adpaetzn@microsoft.com"
        approvers: "adpaetzn@microsoft.com"
        mainpublisher: ESRPRELPACMAN
